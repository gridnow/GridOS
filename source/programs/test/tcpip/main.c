/**
 *   See the readme.txt at the root directory of this project for the idea and originality of this operating system.
 *   See the license.txt at the root directory of this project for the copyright information about this file and project.
 */

/**
	
	系统测试用例

	TCPIP
	Wuxin (82828068@qq.com)
 */

#include <stdio.h>
#include <dlfcn.h>
#include <pthread.h>
#include <ystd.h>
#include <stdlib.h>
#include <string.h>

#include <ddk/net.h>

#define DEFAULT_WRITE_FILE "/os/net/stream/0"

static pthread_t write_worker;

/*
	ARP Request
	ARP, Ethernet (len 6), IPv4 (len 4), Request who-has 10.137.36.15 tell 10.137.36.21, length 46
*/
unsigned char arp_request[] = {
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xd8, 0x9d, 0x67, 0x1a, 0x5c, 0x84, 0x08, 0x06, 0x00, 0x01
        ,0x08, 0x00, 0x06, 0x04, 0x00, 0x01, 0xd8, 0x9d, 0x67, 0x1a, 0x5c, 0x84, 0x0a, 0x89, 0x24, 0x15
        ,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0a, 0x89, 0x24, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        ,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
        

/*
	TCP Connect
	TODO:
*/
unsigned char tcp_connect_request[] = {
		0x48,0x46,0xFB,0xD7,0x6A,0x17,0xC8,0x9C,0xDC,0xFE,0xA8,0x3B,0x08,0x00,0x45,0x00,0x00,0x34,0x27,	0x4E,0x40,
		0x00,0x40,0x06,0xB6,0x3D,0x0A,0x89,0x24,0x18,0x0A,0x89,0x24,0x0F,0x04,0x99,0x00,0x50,0xEB,0xB0,0xEE,0xDF,
		0x00,0x00,0x00,0x00,0x80,0x02,0xFF,0xFF,0x32,0x63,0x00,0x00,0x02,0x04,0x05,0xB4,0x01,0x03,0x03,0x03,0x01,
		0x01,0x04,0x02};

/*
	UDP packet
	TODO:
*/
unsigned char udp_data[] = {
		0xC8,0x9C,0xDC,0xFE,0xA8,0x3B,0x48,0x46,0xFB,0xD7,0x6A,0x17,0x08,0x00,0x45,0x00,0x00,0x7B,0xE3,	0xBA,0x00,0x00,0x3F,
		0x11,0x3A,0x71,0x0A,0x89,0x24,0x26,0x0A,0x89,0x24,0x0F,0x09,0x79,0x09,0x79,0x00,0x67,0x49,0x52,0x31,0x5F,0x6C,0x62,
		0x74,0x34,0x5F,0x30,0x23,0x33,0x38,0x34,0x23,0x43,0x38,0x39,0x43,0x44,0x43,0x46,0x45,0x41,0x34,0x42,0x32,0x23,0x30,
		0x23,0x30,0x23,0x30,0x23,0x32,0x2E,0x35,0x61,0x3A,0x31,0x33,0x39,0x35,0x34,0x36,0x38,0x37,0x37,0x34,0x3A,0x44,0x61,
		0x79,0x73,0x74,0x61,0x72,0x74,0x3A,0x44,0x41,0x59,0x53,0x54,0x41,0x52,0x54,0x3A,0x36,0x32,0x39,0x31,0x34,0x35,0x37,
		0x3A,0xB8,0xDF,0xBA,0xA3,0xCB,0xC9,0x2D,0x58,0x50,0x00,0xCE,0xDE,0xCF,0xDF,0xCD,0xF8,0xC2,0xE7,0xB2,0xBF,0x00};

static void *write_thread(void *para)
{
	y_handle file;
	char *arp_head = NULL, *tcp_head = NULL, *udp_head = NULL;
	size_t package_len = sizeof(struct package_head) * 2 * 4 + sizeof(arp_request)\
			+ sizeof(tcp_connect_request) + sizeof(udp_data);
	
	if (Y_INVALID_HANDLE == (file = y_file_open(DEFAULT_WRITE_FILE, Y_FILE_OPERATION_NOCACHE)))
		goto err0;

	/* 构造arp packet */
	arp_head = malloc(package_len);
	if (!arp_head)
		goto err1;
	memset(arp_head, 0, package_len);
	
	MAKE_PACKAGE((struct package_head *)arp_head, sizeof(arp_request));
	memcpy((void *)arp_head + get_package_pos(arp_head), arp_request, sizeof(arp_request));

	tcp_head = arp_head + get_package_next_head(arp_head);
	MAKE_PACKAGE((struct package_head *)tcp_head, sizeof(tcp_connect_request));
	memcpy((void *)tcp_head + get_package_pos(tcp_head), tcp_connect_request, sizeof(tcp_connect_request));

	udp_head = tcp_head + get_package_next_head(tcp_head);
	MAKE_PACKAGE((struct package_head *)udp_head, sizeof(udp_data));
	memcpy((void *)udp_head + get_package_pos(udp_head), udp_data, sizeof(udp_data));

	//while(1)
	{		
		y_file_write(file, arp_head, package_len);
		//y_file_seek(file, 0, SEEK_CUR);
		//y_file_write(file, tcp_head, sizeof(tcp_connect_request) + sizeof(struct package_head) + sizeof(struct package_pos));
		//y_file_write(file, udp_data, sizeof(udp_data));
		//y_file_seek(file, 0, SEEK_SET);
	}
	
err2:
	free(arp_head);
err1:
	y_file_close(file);
	return NULL;

err0:
	printf("输入文件不存在。\n");
	return NULL;
}

int main()
{
	void *so = dlopen("tcpip.so", 0);	
	int (*entry)(int argc, char **argv);
	
	if (!so)
	{
		printf("协议栈动态库加载失败。\n");
		goto err;
	}
	
	entry = dlentry(so);
	if (!entry)
	{
		printf("Cannot get the entry address of this shared object.\n");
		goto err;
	}
	entry(0, NULL);

	/* 写包线程 */	
	if (pthread_create(&write_worker, NULL, write_thread, 0))
		goto err;
	
	return 0;
err:
	return -1;	
}
